// File: graph_guard.js
// Drop-in guard layer for vis-network graphs.
// Usage:
//   const guard = GraphGuard.create();
//   guard.installGlobalErrorOverlay();
//   const { nodes, edges, report } = guard.normalizeGraphData(rawNodesData, processedEdges);
//   const dsNodes = new vis.DataSet(nodes);
//   const dsEdges = new vis.DataSet(edges);
//   guard.showReport(report);

const GraphGuard = (() => {
  /**
   * @typedef {{id:any,label?:any,info?:any,group?:any,hidden?:any,fixed?:any,x?:any,y?:any,[k:string]:any}} NodeLike
   * @typedef {{id?:any,from:any,to:any,label?:any,title?:any,hidden?:any,[k:string]:any}} EdgeLike
   */

  const DEFAULT_MAX_LABEL = 140;
  const DEFAULT_MAX_INFO = 4000;
  const DEFAULT_MAX_HIGHLIGHT = 200;

  function escapeHtml(value) {
    const s = String(value ?? "");
    return s
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function toId(value) {
    if (value === null || value === undefined) return null;
    const s = String(value).trim();
    return s.length ? s : null;
  }

  function clampText(value, maxLen) {
    const s = String(value ?? "");
    if (s.length <= maxLen) return s;
    return `${s.slice(0, maxLen)}…`;
  }

  function createOverlay() {
    const el = document.createElement("div");
    el.id = "graph-guard-overlay";
    el.style.cssText = [
      "position:fixed",
      "inset:0",
      "z-index:99999",
      "background:rgba(0,0,0,0.85)",
      "backdrop-filter:blur(10px)",
      "color:#fff",
      "padding:16px",
      "font:12px/1.4 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial",
      "display:none",
      "overflow:auto",
    ].join(";");

    el.innerHTML = `
      <div style="max-width:980px;margin:0 auto;">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;">
          <div>
            <div style="font-weight:900;letter-spacing:.08em;text-transform:uppercase;font-size:11px;color:#aaa;">
              Graph Guard
            </div>
            <div id="gg-title" style="font-weight:900;font-size:18px;margin-top:6px;">
              Ошибка визуализации графа
            </div>
            <div id="gg-sub" style="color:#bbb;margin-top:6px;">
              Открой DevTools → Console, но тут уже есть минимум для диагностики.
            </div>
          </div>
          <button id="gg-close" style="
            background:#fff;color:#000;border:0;border-radius:10px;
            padding:10px 12px;font-weight:800;cursor:pointer;
          ">Закрыть</button>
        </div>

        <div style="margin-top:14px;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,0.12);background:rgba(10,10,10,0.65)">
          <div style="font-weight:900;text-transform:uppercase;letter-spacing:.08em;color:#aaa;font-size:10px;margin-bottom:8px;">
            Детали
          </div>
          <pre id="gg-body" style="white-space:pre-wrap;margin:0;color:#e5e5e5"></pre>
        </div>

        <div style="margin-top:10px;color:#aaa;font-size:11px">
          Tip: если пропал граф — чаще всего это <b>ошибка JS</b>, <b>не найденный файл</b> или <b>битые данные</b>.
        </div>
      </div>
    `;

    document.body.appendChild(el);
    el.querySelector("#gg-close").addEventListener("click", () => {
      el.style.display = "none";
    });

    return {
      show(title, body, sub) {
        el.querySelector("#gg-title").textContent = title ?? "Ошибка визуализации графа";
        el.querySelector("#gg-sub").textContent = sub ?? "Смотри детали ниже.";
        el.querySelector("#gg-body").textContent = body ?? "";
        el.style.display = "block";
      },
      hide() {
        el.style.display = "none";
      },
    };
  }

  function create(options = {}) {
    const cfg = {
      maxLabel: options.maxLabel ?? DEFAULT_MAX_LABEL,
      maxInfo: options.maxInfo ?? DEFAULT_MAX_INFO,
      maxHighlight: options.maxHighlight ?? DEFAULT_MAX_HIGHLIGHT,
    };

    const overlay = createOverlay();

    function installGlobalErrorOverlay() {
      window.addEventListener("error", (e) => {
        const msg = e?.message || "Unknown error";
        const src = e?.filename ? `${e.filename}:${e.lineno}:${e.colno}` : "";
        overlay.show(
          "JS ошибка (window.error)",
          `message: ${msg}\nsource: ${src}\nstack:\n${e?.error?.stack || "(no stack)"}`
        );
      });

      window.addEventListener("unhandledrejection", (e) => {
        const reason = e?.reason;
        overlay.show(
          "Unhandled Promise Rejection",
          typeof reason === "string" ? reason : JSON.stringify(reason, null, 2)
        );
      });
    }

    /**
     * Normalizes and sanitizes nodes/edges:
     * - Stringifies ids
     * - Drops bad nodes/edges
     * - Escapes label/info to avoid HTML injection
     * - Ensures edge ids
     */
    function normalizeGraphData(rawNodes, rawEdges) {
      /** @type {Array<NodeLike>} */
      const nodesIn = Array.isArray(rawNodes) ? rawNodes : [];
      /** @type {Array<EdgeLike>} */
      const edgesIn = Array.isArray(rawEdges) ? rawEdges : [];

      const report = {
        nodesIn: nodesIn.length,
        edgesIn: edgesIn.length,
        nodesOut: 0,
        edgesOut: 0,
        droppedNodes: 0,
        droppedEdges: 0,
        reasons: /** @type {Record<string, number>} */ ({}),
        warnings: /** @type {string[]} */ ([]),
      };

      const bump = (k) => {
        report.reasons[k] = (report.reasons[k] || 0) + 1;
      };

      const seen = new Set();
      /** @type {Array<NodeLike>} */
      const nodes = [];
      for (const n of nodesIn) {
        const id = toId(n?.id);
        if (!id) {
          report.droppedNodes++;
          bump("node:missing_id");
          continue;
        }
        if (seen.has(id)) {
          // Keep first, drop duplicates to avoid silent override.
          report.droppedNodes++;
          bump("node:duplicate_id");
          continue;
        }
        seen.add(id);

        const label = clampText(n?.label ?? id, cfg.maxLabel);
        const info = clampText(n?.info ?? "", cfg.maxInfo);

        nodes.push({
          ...n,
          id,
          label: escapeHtml(label).replaceAll("\n", "<br>"),
          info: escapeHtml(info),
          group: toId(n?.group) ?? "company",
        });
      }
      report.nodesOut = nodes.length;

      const nodeIds = new Set(nodes.map((n) => n.id));
      /** @type {Array<EdgeLike>} */
      const edges = [];
      let edgeAuto = 0;

      for (const e of edgesIn) {
        const from = toId(e?.from);
        const to = toId(e?.to);
        if (!from || !to) {
          report.droppedEdges++;
          bump("edge:missing_from_to");
          continue;
        }
        if (!nodeIds.has(from) || !nodeIds.has(to)) {
          report.droppedEdges++;
          bump("edge:missing_node_ref");
          continue;
        }

        const id = toId(e?.id) ?? `e_auto_${edgeAuto++}`;
        const title = clampText(e?.title ?? e?.label ?? "", cfg.maxLabel);

        edges.push({
          ...e,
          id,
          from,
          to,
          // vis-network tooltip uses `title` as HTML; we keep it escaped.
          title: escapeHtml(title),
        });
      }
      report.edgesOut = edges.length;

      if (!nodes.length) report.warnings.push("Nodes dataset is empty → граф нечего рисовать.");
      if (!edges.length) report.warnings.push("Edges dataset is empty → граф будет изолированными точками.");

      return { nodes, edges, report };
    }

    function showReport(report) {
      if (!report) return;
      const body = [
        `nodes: ${report.nodesOut}/${report.nodesIn} (dropped ${report.droppedNodes})`,
        `edges: ${report.edgesOut}/${report.edgesIn} (dropped ${report.droppedEdges})`,
        "",
        "reasons:",
        JSON.stringify(report.reasons, null, 2),
        "",
        "warnings:",
        (report.warnings || []).join("\n") || "(none)",
      ].join("\n");

      if (report.droppedNodes || report.droppedEdges || (report.warnings || []).length) {
        // non-fatal report: show briefly, user can close.
        overlay.show("Graph Guard: отчёт нормализации", body, "Данные были исправлены/очищены для стабильной отрисовки.");
      }
    }

    function hardenSearchHighlight(nodesDataSet, nodeIds) {
      // Optional helper: highlights found nodes safely (limit by cfg.maxHighlight)
      const ids = Array.isArray(nodeIds) ? nodeIds.slice(0, cfg.maxHighlight) : [];
      const updates = ids.map((id) => ({
        id,
        font: { color: "#fff", strokeWidth: 8, strokeColor: "#2563eb" },
      }));
      nodesDataSet.update(updates);
    }

    return {
      installGlobalErrorOverlay,
      normalizeGraphData,
      showReport,
      hardenSearchHighlight,
      overlay,
      cfg,
    };
  }

  return { create };
})();

/*
=== Minimal integration example (paste into your HTML, BEFORE creating vis.DataSet) ===

const guard = GraphGuard.create();
guard.installGlobalErrorOverlay();

const normalized = guard.normalizeGraphData(rawNodesData, processedEdges);
guard.showReport(normalized.report);

const nodes = new vis.DataSet(normalized.nodes);
const edges = new vis.DataSet(normalized.edges);

*/
