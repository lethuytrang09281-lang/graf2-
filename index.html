<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forensic Graph: Elton-2 Investigation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/standalone/umd/vis-network.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #050505; color: #fff; margin: 0; overflow: hidden; }
        #network-container { width: 100%; height: calc(100vh - 64px); background-color: #050505; }
        .vis-network:focus { outline: none; }

        .vercel-panel {
            background: rgba(10, 10, 10, 0.85);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

        .nav-btn {
            font-size: 11px; font-weight: 600; color: #888;
            padding: 6px 14px; transition: all 0.2s; border-radius: 6px;
            border: 1px solid transparent; background: transparent;
        }
        .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .active-filter { color: #fff; background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }

        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 10px; color: #aaa; margin-bottom: 6px; }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; }

        input[type="range"] { accent-color: #3b82f6; }
    </style>
</head>
<body>

    <header class="h-16 border-b border-white/10 flex items-center justify-between px-4">
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center text-xl font-black">E2</div>
                <div>
                    <h1 class="font-extrabold text-base tracking-tight">Elton-2</h1>
                    <p class="text-[10px] text-zinc-500 font-semibold tracking-widest uppercase">Forensic Graph</p>
                </div>
            </div>

            <div class="h-6 w-px bg-white/10 mx-2"></div>

            <nav id="filters" class="flex space-x-1">
                <button data-analytic-filter="profit" onclick="applyFilter('profit', this)" class="nav-btn">üí∞ –í—ã—Ä—É—á–∫–∞</button>
                <button data-analytic-filter="offshore" onclick="applyFilter('offshore', this)" class="nav-btn">üåç –û—Ñ—à–æ—Ä—ã</button>
                <button data-analytic-filter="empire" onclick="applyFilter('empire', this)" class="nav-btn">üè∞ –ò–º–ø–µ—Ä–∏—è</button>
                <button data-analytic-filter="nko" onclick="applyFilter('nko', this)" class="nav-btn">üõ°Ô∏è –•–∞–±—ã</button>
                <button data-analytic-filter="transit" onclick="applyFilter('transit', this)" class="nav-btn">üîÑ –¢—Ä–∞–Ω–∑–∏—Ç</button>
                <button data-analytic-filter="record" onclick="applyFilter('record', this)" class="nav-btn">üìà –£–ö –†–µ–∫–æ—Ä–¥</button>
                <div class="h-6 w-px bg-white/10 mx-2"></div>
                <button onclick="toggleOsint(this)" class="nav-btn" id="osint-toggle">üõ∞Ô∏è OSINT</button>
                <button onclick="togglePivotLayout(this)" class="nav-btn" id="pivot-toggle">üéØ Pivot</button>
                <button onclick="toggleClusterLayout(this)" class="nav-btn" id="cluster-toggle">üß≤ –ö–ª–∞—Å—Ç–µ—Ä—ã</button>
            </nav>
        </div>

        <div class="flex items-center space-x-3">
            <div class="flex items-center space-x-2 bg-black border border-white/20 rounded-md px-3 py-2 hidden lg:flex">
                <label for="springLength" class="text-[9px] text-zinc-500 uppercase tracking-widest cursor-pointer" title="–î–ª–∏–Ω–∞ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É —É–∑–ª–∞–º–∏">–†–∞–¥–∏—É—Å:</label>
                <input type="range" id="springLength" min="30" max="350" value="130" class="w-24 h-1 bg-zinc-700 rounded-lg appearance-none cursor-pointer">
            </div>

            <div class="relative">
                <input type="text" id="node-search" placeholder="–ü–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–∞..."
                    class="bg-black border border-white/20 rounded-md px-4 py-2 text-xs text-white focus:border-blue-500 outline-none w-64 transition-all focus:ring-1 focus:ring-blue-500">
            </div>
            <button onclick="resetView()" class="bg-white text-black px-4 py-2 rounded-md text-[11px] font-bold uppercase hover:bg-zinc-200 transition-colors">–°–±—Ä–æ—Å</button>
        </div>
    </header>

    <main class="flex">
        <aside class="w-72 border-r border-white/10 p-4 overflow-y-auto custom-scrollbar hidden lg:block">
            <div class="vercel-panel p-4 rounded-xl mb-4">
                <h3 class="text-[11px] font-black uppercase tracking-widest mb-3 text-white">–õ–µ–≥–µ–Ω–¥–∞</h3>

                <h4 class="text-[10px] text-zinc-500 uppercase font-black tracking-widest mb-3 opacity-80">–¢–∏–ø—ã –æ–±—ä–µ–∫—Ç–æ–≤</h4>
                <div class="legend-item"><div class="legend-color bg-red-600 rounded-full"></div> –ë–∞–Ω–∫—Ä–æ—Ç (–î–æ–ª–∂–Ω–∏–∫)</div>
                <div class="legend-item"><div class="legend-color bg-emerald-500"></div> –ö–æ–º–º–µ—Ä—á–µ—Å–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è</div>
                <div class="legend-item"><div class="legend-color bg-amber-500"></div> –§–æ–Ω–¥ / –ü—Ä–∏—Ö–æ–¥</div>
                <div class="legend-item"><div class="legend-color bg-purple-500 rounded-full"></div> –ü–µ—Ä—Å–æ–Ω–∞</div>
                <div class="legend-item"><div class="legend-color bg-blue-500"></div> –ì–æ—Å. —Å—Ç—Ä—É–∫—Ç—É—Ä–∞</div>
                <div class="legend-item"><div class="legend-color bg-zinc-500"></div> –ü–æ—Å—Ä–µ–¥–Ω–∏–∫</div>

                <h4 class="text-[10px] text-zinc-500 uppercase font-black tracking-widest mt-4 mb-2 opacity-80">–¢–∏–ø—ã —Å–≤—è–∑–µ–π</h4>
                <div class="legend-item"><div class="w-4 h-0.5 bg-emerald-500"></div> –§–∏–Ω–∞–Ω—Å—ã / –í—ã—Ä—É—á–∫–∞</div>
                <div class="legend-item"><div class="w-4 h-0.5 bg-amber-500"></div> –î–æ–ª–≥ / –ó–∞–µ–º / –¶–µ—Å—Å–∏—è</div>
                <div class="legend-item"><div class="w-4 h-0.5 bg-red-500"></div> –°—É–¥ / –ö–æ–Ω—Ñ–ª–∏–∫—Ç</div>
                <div class="legend-item"><div class="w-4 h-0.5 bg-zinc-500"></div> –ö–æ–Ω—Ç—Ä–æ–ª—å / –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>

                <h4 class="text-[10px] text-zinc-500 uppercase font-black tracking-widest mt-4 mb-2 opacity-80">OSINT (SpiderFoot)</h4>
                <div class="legend-item"><div class="legend-color bg-cyan-600 rounded-full"></div> IP-–∞–¥—Ä–µ—Å</div>
                <div class="legend-item"><div class="legend-color bg-sky-600 rounded-full"></div> –î–æ–º–µ–Ω / DNS</div>
                <div class="legend-item"><div class="legend-color bg-indigo-600 rounded-full"></div> Email</div>
                <div class="legend-item"><div class="legend-color bg-violet-600 rounded-full"></div> URL</div>
                <div class="legend-item"><div class="legend-color bg-blue-600 rounded-full"></div> ASN</div>
                <div class="legend-item"><div class="legend-color bg-zinc-600 rounded-full"></div> –ü—Ä–æ—á–µ–µ</div>
            </div>

            <div class="vercel-panel p-4 rounded-xl">
                <h3 class="text-[11px] font-black uppercase tracking-widest mb-2 text-white">–ü–æ–¥—Å–∫–∞–∑–∫–∏</h3>
                <p class="text-xs text-zinc-400 leading-relaxed">
                    ‚Ä¢ –ö–ª–∏–∫ –ø–æ —É–∑–ª—É ‚Äî –¥–µ—Ç–∞–ª–∏ —Å–ø—Ä–∞–≤–∞.<br>
                    ‚Ä¢ –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç —É–∑–µ–ª.<br>
                    ‚Ä¢ –ü–æ–∏—Å–∫ ‚Äî —Ñ–æ–∫—É—Å –Ω–∞ –æ–±—ä–µ–∫—Ç.<br>
                    ‚Ä¢ –§–∏–ª—å—Ç—Ä—ã ‚Äî –≤—ã–¥–µ–ª—è—é—Ç –ø–æ–¥—Å–µ—Ç–∏.
                </p>
            </div>
        </aside>

        <section class="flex-1 relative">
            <div id="network-container"></div>

            <div id="analytic-report" class="vercel-panel absolute top-4 left-4 w-80 p-4 rounded-xl hidden">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h2 id="report-title" class="text-sm font-extrabold tracking-tight"></h2>
                        <p id="report-text" class="text-xs text-zinc-400 mt-1"></p>
                    </div>
                    <button onclick="closeReport()" class="text-zinc-500 hover:text-white text-lg leading-none">√ó</button>
                </div>
                <div class="mt-3">
                    <h3 class="text-[10px] text-zinc-500 uppercase font-black mb-2 tracking-widest">–û–±—ä–µ–∫—Ç—ã</h3>
                    <div id="report-nodes" class="space-y-1 max-h-64 overflow-y-auto custom-scrollbar pr-1"></div>
                </div>
            </div>

            <div id="info-sidebar" class="vercel-panel absolute top-4 right-4 w-96 p-4 rounded-xl hidden">
                <div class="flex justify-between items-start mb-2">
                    <div id="sidebar-header"></div>
                    <button onclick="closeSidebar()" class="text-zinc-500 hover:text-white text-lg leading-none">√ó</button>
                </div>
                <div id="info-content" class="text-sm text-zinc-300 custom-scrollbar overflow-y-auto max-h-[70vh] pr-1"></div>
            </div>
        </section>
    </main>

    <script src="sf_data.js"></script>
    <script>
        const baseNodesData = [
            { id: 'SE2', label: '–ê–û "–°–∞–Ω–∞—Ç–æ—Ä–∏–π\\n"–ï–ª—å—Ç–æ–Ω-2"', group: 'bankrupt', info: '–ö–ª—é—á–µ–≤–æ–π –∞–∫—Ç–∏–≤. 2024: –∏—Å–∫ –æ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–µ, –≤–≤–µ–¥–µ–Ω–æ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ.' },
            { id: 'CH_L', label: '–ß—É–≥—É–Ω–æ–≤\\n–õ.–°.', group: 'person', info: '–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—â–µ–µ –ª–∏—Ü–æ (85%), –±–µ–Ω–µ—Ñ–∏—Ü–∏–∞—Ä.' , pattern: 'empire'},
            { id: 'MIKHEEV', label: '–ú–∏—Ö–µ–µ–≤\\n–ú.–°.', group: 'person', info: '–ú–∏–Ω–æ—Ä–∏—Ç–∞—Ä–∏–π (15%, –≤ –ø—Ä–æ—à–ª–æ–º).', pattern: 'empire' },
            { id: 'KOL', label: '–ö–æ–ª–µ—Å–Ω–∏–∫–æ–≤\\n–ê.–ê.', group: 'person', info: '–î–∏—Ä–µ–∫—Ç–æ—Ä –°–ï2.' },
            { id: 'BOGD', label: '–ë–æ–≥–¥–∞–Ω–æ–≤\\n–°.–°.', group: 'person', info: '–ë—ã–≤—à–∏–π –¥–∏—Ä–µ–∫—Ç–æ—Ä –°–ï2.' },
            { id: 'ZAKH', label: '–ó–∞—Ö–∞—Ä—á–µ–Ω–∫–æ\\n–î.–ê.', group: 'person', info: '–ù–æ–º–∏–Ω–∞–ª—å–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü —Ä—è–¥–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä.' },
            { id: 'KHAR', label: '–•–∞—Ä—á–µ–Ω–∫–æ\\n–ö.–ù.', group: 'person', info: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π/–Æ—Ä–∏—Å—Ç.' },
            { id: 'EM', label: '–û–û–û\\n"–≠–ª—å—Ç–æ–Ω –ú"', group: 'company', info: '–ê—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞. –ö–∞–Ω–∞–ª –≤—ã–≤–æ–¥–∞ –≤—ã—Ä—É—á–∫–∏.', pattern: 'profit' },
            { id: 'BA_I', label: '–ë–∞–≥–µ–Ω–æ–≤–∞\\n–ò.–°.', group: 'person', info: '–ù–æ–º–∏–Ω–∞–ª—å–Ω—ã–π –≤–ª–∞–¥–µ–ª–µ—Ü "–≠–ª—å—Ç–æ–Ω –ú".', pattern: 'profit' },
            { id: 'CH_A_P', label: '–ß—É–≥—É–Ω–æ–≤\\n–ê.–ü.', group: 'person', info: '–≠–∫—Å-–≤–ª–∞–¥–µ–ª–µ—Ü "–≠–ª—å—Ç–æ–Ω –ú".', pattern: 'profit' },
            { id: 'ALT', label: '–ê–ª—å—Ç–º–∞–Ω\\n–ò.–î.', group: 'person', info: '–≠–∫—Å-–¥–∏—Ä–µ–∫—Ç–æ—Ä "–≠–ª—å—Ç–æ–Ω –ú".', pattern: 'profit' },
            { id: 'MISYURINA', label: '–ú–∏—Å—é—Ä–∏–Ω–∞\\n–ï.–í.', group: 'person', info: '–î–∏—Ä–µ–∫—Ç–æ—Ä —Ñ–∏–ª–∏–∞–ª–∞ "–≠–ª—å—Ç–æ–Ω –ú".', pattern: 'profit' },
            { id: 'CONF', label: '–ë–§\\n"–°–æ–≥–ª–∞—Å–∏–µ"', group: 'fund', info: '–ë–ª–∞–≥–æ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–æ–Ω–¥. –•–∞–± –¥–ª—è –∞–∫—Ç–∏–≤–æ–≤.', pattern: 'nko' },
            { id: 'MOBRAY', label: '–û–û–û\\n"MOBRAY"', group: 'company', info: '–í–ª–∞–¥–µ–Ω–∏–µ: –ß—É–≥—É–Ω–æ–≤ –ê.–ü. –§–∏–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–π–º—ã.', pattern: 'offshore' },
            { id: 'FINWAY', label: '–û–û–û\\n"–§–∏–Ω–≤–µ–π"', group: 'company', info: '–ó–∞–µ–º—â–∏–∫. –§–∏–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–π–º—ã.', pattern: 'offshore' },
            { id: 'FZ', label: '–û–û–û\\n"–§–∞–º–∏–ª –ó–µ—Ç"', group: 'company', info: '–§–∏–∫—Ç–∏–≤–Ω–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å.', pattern: 'offshore' },
            { id: 'FUNDUS', label: '–û–û–û\\n"–§—É–Ω–¥—É—Å"', group: 'company', info: '–§–∏–∫—Ç–∏–≤–Ω–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å.', pattern: 'offshore' },
            { id: 'FZ_OFF', label: 'FAMILZET LTD\\n(–ö–∏–ø—Ä)', group: 'intermediary', info: '–û—Ñ—à–æ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞. –¶–µ—Å—Å–∏—è.', pattern: 'offshore' },
            { id: 'SVAZ', label: '–û–û–û\\n"–°–≤—è–∑—å"', group: 'company', info: '–§–∏–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–π–º—ã.', pattern: 'offshore' },
            { id: 'UGL', label: '–û–û–û\\n"–Æ–≥–ª–∞–π–Ω"', group: 'company', info: '–§–∏–∫—Ç–∏–≤–Ω–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å.', pattern: 'offshore' },
            { id: 'VET', label: '–û–û–û\\n"–í–≠–¢"', group: 'company', info: '–§–∏–∫—Ç–∏–≤–Ω–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å.', pattern: 'offshore' },
            { id: 'SUD', label: '–ê—Ä–±–∏—Ç—Ä–∞–∂–Ω—ã–π\\n—Å—É–¥', group: 'gov', info: '–ò—Å–∫ –æ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–µ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å–ø–æ—Ä—ã.', pattern: 'record' },
            { id: 'SBER', label: '–°–±–µ—Ä–±–∞–Ω–∫', group: 'gov', info: '–ö—Ä–µ–¥–∏—Ç–æ—Ä/—Å—á–µ—Ç–∞.', pattern: 'transit' },
            { id: 'VTB', label: '–í–¢–ë', group: 'gov', info: '–ö—Ä–µ–¥–∏—Ç–æ—Ä/—Å—á–µ—Ç–∞.', pattern: 'transit' },
            { id: 'GPB', label: '–ì–∞–∑–ø—Ä–æ–º–±–∞–Ω–∫', group: 'company', info: '–õ–∏—á–Ω—ã–µ —Å—á–µ—Ç–∞ –ß—É–≥—É–Ω–æ–≤–∞ –õ.–°. –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å—Ä–µ–¥—Å—Ç–≤.', pattern: 'transit' }
        ];

        const rawNodesData = [
            ...baseNodesData,
            ...(window.rawNodesData || [])
        ];

        const baseEdgesData = [
            { from: 'CH_L', to: 'SE2', label: '–í–ª–∞–¥–µ–ª–µ—Ü (85%)' }, { from: 'MIKHEEV', to: 'SE2', label: '15% (–≤ –ø—Ä–æ—à–ª–æ–º)' },
            { from: 'BOGD', to: 'SE2', label: '–≠–∫—Å-–¥–∏—Ä–µ–∫—Ç–æ—Ä' }, { from: 'KOL', to: 'SE2', label: '–î–∏—Ä–µ–∫—Ç–æ—Ä' },
            { from: 'ZAKH', to: 'SE2', label: '–ù–æ–º–∏–Ω–∞–ª' }, { from: 'KHAR', to: 'SE2', label: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ' },
            { from: 'SE2', to: 'EM', label: '–í—ã–≤–æ–¥ –≤—ã—Ä—É—á–∫–∏' }, { from: 'CH_L', to: 'EM', label: '–ì–µ–Ω–¥–∏—Ä–µ–∫—Ç–æ—Ä' },
            { from: 'BA_I', to: 'EM', label: '–ù–æ–º–∏–Ω–∞–ª (100%)' }, { from: 'CH_A_P', to: 'EM', label: '–≠–∫—Å-–≤–ª–∞–¥–µ–ª–µ—Ü' },
            { from: 'ALT', to: 'EM', label: '–≠–∫—Å-–¥–∏—Ä–µ–∫—Ç–æ—Ä' }, { from: 'MISYURINA', to: 'EM', label: '–î–∏—Ä–µ–∫—Ç–æ—Ä —Ñ–∏–ª.' },
            { from: 'BA_I', to: 'CONF', label: '–£—á—Ä–µ–¥–∏—Ç–µ–ª—å' }, { from: 'KHAR', to: 'EM', label: '–í–∑—ã—Å–∫–∞–Ω–∏–µ —É–±—ã—Ç–∫–æ–≤' },
            { from: 'CH_L', to: 'BA_I', label: '–°—É–ø—Ä—É–≥' }, { from: 'SE2', to: 'MOBRAY', label: '–§–∏–∫—Ç–∏–≤–Ω—ã–π –∑–∞–µ–º' },
            { from: 'CH_A_P', to: 'MOBRAY', label: '–í–ª–∞–¥–µ–ª–µ—Ü' }, { from: 'SE2', to: 'FINWAY', label: '–§–∏–∫—Ç–∏–≤–Ω—ã–π –∑–∞–µ–º' },

            { from: 'SE2', to: 'FZ', label: '–§–∏–∫—Ç–∏–≤–Ω—ã–π –∑–∞–µ–º' }, { from: 'SE2', to: 'FUNDUS', label: '–§–∏–∫—Ç–∏–≤–Ω—ã–π –∑–∞–µ–º' },
            { from: 'FZ', to: 'FZ_OFF', label: '–¶–µ—Å—Å–∏—è –¥–æ–ª–≥–∞' }, { from: 'FZ_OFF', to: 'SE2', label: '–ò—Å–∫ (–¥–æ–ª–≥)' },

            { from: 'SE2', to: 'SVAZ', label: '–§–∏–∫—Ç–∏–≤–Ω—ã–π –∑–∞–µ–º' }, { from: 'SE2', to: 'UGL', label: '–§–∏–∫—Ç–∏–≤–Ω—ã–π –∑–∞–µ–º' },
            { from: 'SE2', to: 'VET', label: '–§–∏–∫—Ç–∏–≤–Ω—ã–π –∑–∞–µ–º' },

            { from: 'SUD', to: 'SE2', label: '–ë–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–æ' }, { from: 'SUD', to: 'EM', label: '–°—É–±—Å–∏–¥–∏–∞—Ä–∫–∞' },

            { from: 'SE2', to: 'SBER', label: '–°—á–µ—Ç' }, { from: 'SE2', to: 'VTB', label: '–°—á–µ—Ç' }, { from: 'SE2', to: 'GPB', label: '–°—á–µ—Ç' }
        ];

        const rawEdgesData = [
            ...baseEdgesData,
            ...(window.rawEdgesData || [])
        ];

        // –ê–õ–ì–û–†–ò–¢–ú –†–ê–°–ö–†–ê–°–ö–ò –†–ï–ë–ï–† (–°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç —Å –ª–∏–Ω–∏–π)
        const processedEdges = rawEdgesData.map((e, idx) => {
            const edgeId = e.id ?? `e_${idx}`;
            let edgeColor = '#555';
            let width = 1.2;
            let isDashed = false;
            const lbl = (e.label || '').toLowerCase();

            if (lbl.includes('–≤—ã—Ä—É—á') || lbl.includes('—Ñ–∏–Ω–∞–Ω—Å') || lbl.includes('–æ–±–Ω–∞–ª') || lbl.includes('–Ω–∞–ª–∏—á') || lbl.includes('—Å—á–µ—Ç') || lbl.includes('—Ç—Ä–∞–Ω–∑–∞–∫—Ü') || lbl.includes('–≤—ã–≤–æ–¥') || lbl.includes('–ø–ª–∞—Ç–µ–ª—å—â–∏–∫')) { edgeColor = '#10b981'; width = 2.5; }
            else if (lbl.includes('–∑–∞–µ–º') || lbl.includes('–¥–æ–ª–≥') || lbl.includes('—Ü–µ—Å—Å') || lbl.includes('–±–∞–∑') || lbl.includes('—Ä–∞—Å—á–µ—Ç') || lbl.includes('—É—Å—Ç—É–ø–∫–∞')) { edgeColor = '#f59e0b'; width = 2; }
            else if (lbl.includes('—Å—É–¥') || lbl.includes('–∏—Å–∫') || lbl.includes('–≤–∑—ã—Å–∫–∞–Ω') || lbl.includes('–∫—Ä–µ–¥–∏—Ç–æ—Ä') || lbl.includes('–ø—Ä–æ–≤–µ—Ä–∫–∞') || lbl.includes('—é—Ä–∏—Å—Ç') || lbl.includes('—Å—É–¥—å—è')) { edgeColor = '#ef4444'; width = 2; }

            if (lbl.includes('–Ω–æ–º–∏') || lbl.includes('—Ñ–∏–∫—Ç') || lbl.includes('–ø—Ä–æ—à–ª–æ–º')) { isDashed = true; }

            return {
                ...e,
                id: edgeId,
                label: undefined,
                title: e.title || e.label,
                width: width,
                color: { color: edgeColor, highlight: '#fff', hover: '#fff' },
                dashes: isDashed
            };
        });

        const nodes = new vis.DataSet(rawNodesData);
        const edges = new vis.DataSet(processedEdges);

        const options = {
            nodes: {
                font: { size: 12, face: 'Inter', color: '#fff', strokeWidth: 4, strokeColor: '#000', multi: 'html' },
                borderWidth: 2, borderWidthSelected: 4,
                shadow: { enabled: true, color: 'rgba(0,0,0,0.8)', size: 10, x: 2, y: 2 }
            },
            edges: {
                smooth: { type: 'continuous', forceDirection: 'none' },
                arrows: { to: { enabled: true, scaleFactor: 0.5 } },
                hoverWidth: 1.5
            },
            groups: {
                bankrupt: { color: { background: '#dc2626', border: '#ef4444' }, shape: 'box', font: { size: 15, bold: true } },
                company: { color: { background: '#059669', border: '#10b981' }, shape: 'box' },
                fund: { color: { background: '#d97706', border: '#f59e0b' }, shape: 'box' },
                person: { color: { background: '#7c3aed', border: '#a78bfa' }, shape: 'circle' },
                gov: { color: { background: '#2563eb', border: '#60a5fa' }, shape: 'box' },
                intermediary: { color: { background: '#52525b', border: '#a1a1aa' }, shape: 'box' },

                osint_ip: { color: { background: '#0891b2', border: '#22d3ee' }, shape: 'circle' },
                osint_domain: { color: { background: '#0284c7', border: '#38bdf8' }, shape: 'circle' },
                osint_email: { color: { background: '#4f46e5', border: '#818cf8' }, shape: 'circle' },
                osint_url: { color: { background: '#7c3aed', border: '#a78bfa' }, shape: 'circle' },
                osint_asn: { color: { background: '#2563eb', border: '#60a5fa' }, shape: 'circle' },
                osint_misc: { color: { background: '#52525b', border: '#a1a1aa' }, shape: 'circle' }
            },
            physics: {
                enabled: true,
                solver: 'forceAtlas2Based',
                forceAtlas2Based: { gravitationalConstant: -60, centralGravity: 0.01, springLength: 130, springConstant: 0.03 },
                stabilization: { iterations: 150 }
            },
            interaction: { hover: true, tooltipDelay: 120 }
        };

        const container = document.getElementById('network-container');
        const data = { nodes: nodes, edges: edges };
        const network = new vis.Network(container, data, options);

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–¥–∏—É—Å–æ–º (springLength)
        document.getElementById('springLength').addEventListener('input', (e) => {
            const len = parseInt(e.target.value, 10);
            network.setOptions({ physics: { forceAtlas2Based: { springLength: len } } });
            network.stabilize(50);
        });

        // DRAG: —Ñ–∏–∫—Å–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ç—è–Ω—É—Ç—ã–π —É–∑–µ–ª
        network.on("dragEnd", params => {
            if (params.nodes.length > 0) {
                nodes.update(params.nodes.map(id => ({ id: id, fixed: true })));
            }
        });

        // –ü–û–ò–°–ö –£–ó–õ–ê
        document.getElementById('node-search').addEventListener('input', (e) => {
            const val = (e.target.value || '').toLowerCase().trim();
            if (val.length < 2) {
                if (val.length === 0) resetView();
                return;
            }

            const found = rawNodesData.find(n => {
                const label = (n.label || n.id || '').toLowerCase();
                const info = (n.info || '').toLowerCase();
                return label.includes(val) || info.includes(val);
            });

            if (!found) return;

            if (currentAnalyticFilter) clearAnalyticFilter({ fit: false });

            network.focus(found.id, { scale: 1.2, animation: true });
            network.selectNodes([found.id]);
            showNodeInfo(found.id);
        });

        // –ö–õ–ò–ö
        network.on("click", e => {
            if (e.nodes.length > 0) {
                showNodeInfo(e.nodes[0]);
                return;
            }

            closeSidebar();

            // –ö–ª–∏–∫ –ø–æ –ø—É—Å—Ç–æ–º—É –º–µ—Å—Ç—É: —Å–Ω–∏–º–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä, –Ω–µ –ª–æ–º–∞—è OSINT/layout-—Ç–æ–≥–≥–ª—ã.
            if (currentAnalyticFilter) clearAnalyticFilter({ fit: true });
        });

        function showNodeInfo(id) {
            const node = nodes.get(id); if(!node) return;
            const sidebar = document.getElementById('info-sidebar'), header = document.getElementById('sidebar-header'), content = document.getElementById('info-content');

            let badgeColor = 'bg-zinc-600';
            if(node.group === 'bankrupt') badgeColor = 'bg-red-600';
            if(node.group === 'company') badgeColor = 'bg-emerald-600';
            if(node.group === 'fund') badgeColor = 'bg-amber-600';
            if(node.group === 'person') badgeColor = 'bg-purple-600';
            if(node.group === 'gov') badgeColor = 'bg-blue-600';
            if(node.group === 'intermediary') badgeColor = 'bg-zinc-500';
            if((node.group || '').startsWith('osint_')) badgeColor = 'bg-cyan-700';

            header.innerHTML = `
                <div>
                    <div class="flex items-center gap-2">
                        <span class="px-2 py-1 rounded-md text-[10px] font-black uppercase tracking-widest ${badgeColor}">${node.group || 'node'}</span>
                        <span class="text-xs text-zinc-500 font-semibold">${node.id}</span>
                    </div>
                    <h2 class="text-lg font-extrabold tracking-tight mt-2">${(node.label || node.id || '').replaceAll('\n','<br>')}</h2>
                </div>
            `;

            const connected = edges.get({ filter: e => e.from === id || e.to === id });
            const links = connected.map(e => {
                const otherId = e.from === id ? e.to : e.from;
                const other = nodes.get(otherId);
                const lbl = e.title || '';
                return `<div class="p-2 bg-black/40 border border-white/5 rounded-lg text-xs text-zinc-300 hover:bg-white/10 hover:text-white cursor-pointer transition-colors" onclick="focusOnNode('${otherId}')">
                    <div class="font-semibold">${(other?.label || otherId || '').replaceAll('\n',' ')}</div>
                    <div class="text-[10px] text-zinc-500">${lbl}</div>
                </div>`;
            }).join('');

            content.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-[10px] text-zinc-500 uppercase font-black tracking-widest mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</h3>
                    <p class="text-sm text-zinc-300 leading-relaxed">${node.info || '‚Äî'}</p>
                </div>
                <h3 class="text-[10px] text-zinc-500 uppercase font-black mb-3 tracking-widest">–°–≤—è–∑–∏ –æ–±—ä–µ–∫—Ç–∞ (${connected.length})</h3>
                <div class="space-y-1">${links}</div>
            `;
            sidebar.classList.remove('hidden');
        }

        function focusOnNode(id) {
            network.focus(id, { scale: 1.2, animation: true });
            network.selectNodes([id]);
            showNodeInfo(id);
        }

        const ANALYTIC_TITLES = {
            profit: '–ö–∞–Ω–∞–ª: –ó–∞—Ö–≤–∞—Ç –≤—ã—Ä—É—á–∫–∏',
            offshore: '–ö–∞–Ω–∞–ª: –û—Ñ—à–æ—Ä–Ω–∞—è —Å–µ—Ç—å',
            empire: '–ò–º–ø–µ—Ä–∏—è –ß—É–≥—É–Ω–æ–≤–∞',
            nko: '–ö–∞–Ω–∞–ª: –ù–ö–û –∏ –•–∞–±—ã',
            transit: '–û–±–Ω–∞–ª –∏ –¢—Ä–∞–Ω–∑–∏—Ç',
            record: '–£–ö –†–µ–∫–æ—Ä–¥ –ö–∞–ø–∏—Ç–∞–ª'
        };

        const ANALYTIC_TEXTS = {
            profit: '–ê–∫–∫—É–º—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏ —Å–∞–Ω–∞—Ç–æ—Ä–∏—è.',
            offshore: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–∫—Ç–∏–≤–Ω–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏.',
            empire: '–ê–∫—Ç–∏–≤—ã (–ù–ü–ó, –ø–æ—Å–µ–ª–∫–∏, –º–µ–¥—Ü–µ–Ω—Ç—Ä—ã).',
            nko: '–°–∫—Ä—ã—Ç–∏–µ –∞–∫—Ç–∏–≤–æ–≤ –≤ —Ñ–æ–Ω–¥–∞—Ö –∏ –ø—Ä–∏—Ö–æ–¥–∞—Ö.',
            transit: '–í—ã–≤–æ–¥ –Ω–∞–ª–∏—á–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –¥—Ä–æ–ø–æ–≤.',
            record: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∏—Ç–Ω—ã–º–∏ –∫–æ–º–ø–∞–Ω–∏—è–º–∏.'
        };

        let currentAnalyticFilter = null;

        function getAnalyticButtons() {
            return document.querySelectorAll('[data-analytic-filter]');
        }

        function setActiveAnalyticButton(type) {
            getAnalyticButtons().forEach(b => b.classList.remove('active-filter'));
            if (!type) return;
            const btn = document.querySelector(`[data-analytic-filter="${type}"]`);
            if (btn) btn.classList.add('active-filter');
        }

        function setToggleActive(id, active) {
            const el = document.getElementById(id);
            if (el) el.classList.toggle('active-filter', active);
        }

        function updateEdgeVisibilityFromNodes() {
            const hiddenById = new Map(nodes.get().map(n => [n.id, !!n.hidden]));
            const edgeUpdates = edges.get().map(e => ({
                id: e.id,
                hidden: !!hiddenById.get(e.from) || !!hiddenById.get(e.to)
            }));
            edges.update(edgeUpdates);
        }

        function showOnlyNodes(visibleIds) {
            const visible = new Set(visibleIds);
            nodes.update(rawNodesData.map(n => ({
                id: n.id,
                hidden: !visible.has(n.id),
                fixed: false,
                x: undefined,
                y: undefined,
                font: { color: '#fff', strokeColor: '#000' }
            })));
            updateEdgeVisibilityFromNodes();
        }

        function showAllNodesAndEdges() {
            nodes.update(rawNodesData.map(n => ({
                id: n.id,
                hidden: false,
                fixed: false,
                x: undefined,
                y: undefined,
                font: { color: '#fff', strokeColor: '#000' }
            })));
            edges.update(processedEdges.map(e => ({ id: e.id, hidden: false })));
        }

        function clearAnalyticFilter({ fit = true } = {}) {
            if (!currentAnalyticFilter && document.getElementById('analytic-report').classList.contains('hidden')) return;
            currentAnalyticFilter = null;
            setActiveAnalyticButton(null);
            showAllNodesAndEdges();
            closeReport();
            if (fit) network.fit({ animation: { duration: 800, easingFunction: "easeInOutQuad" } });
        }

        function disableOsint({ fit = false } = {}) {
            if (!osintEnabled) return;
            osintEnabled = false;
            setToggleActive('osint-toggle', false);

            const allNodes = nodes.get();
            const updates = allNodes.map(n => ({
                id: n.id,
                color: { background: undefined, border: undefined },
                size: undefined
            }));
            nodes.update(updates);

            if (fit) network.fit({ animation: { duration: 800, easingFunction: "easeInOutQuad" } });
        }

        function disableLayouts() {
            if (pivotLayoutOn) {
                pivotLayoutOn = false;
                setToggleActive('pivot-toggle', false);
                clearPivotRadialLayout();
            }
            if (clusterOn) {
                clusterOn = false;
                setToggleActive('cluster-toggle', false);
                clearClusterLayout();
            }
        }

        function applyFilter(type, btnElement) {
            closeSidebar();

            // –ù–µ —Å–º–µ—à–∏–≤–∞–µ–º —Ä–µ–∂–∏–º—ã: –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä = —á–∏—Å—Ç—ã–π –≥—Ä–∞—Ñ –±–µ–∑ OSINT/layout.
            disableOsint({ fit: false });
            disableLayouts();

            currentAnalyticFilter = type;
            setActiveAnalyticButton(type);

            const report = document.getElementById('analytic-report');
            const targetNodes = rawNodesData.filter(n => n.pattern === type || n.id === 'SE2');
            const targetIds = targetNodes.map(n => n.id);

            showOnlyNodes(targetIds);

            network.fit({ nodes: targetIds, animation: { duration: 800, easingFunction: "easeInOutQuad" } });

            report.classList.remove('hidden');
            document.getElementById('report-title').innerText = ANALYTIC_TITLES[type] || '';
            document.getElementById('report-text').innerText = ANALYTIC_TEXTS[type] || '';
            document.getElementById('report-nodes').innerHTML = targetNodes
                .filter(n => n.id !== 'SE2')
                .map(n => {
                    const label = (n.label || n.id || '').replaceAll('\n', ' ');
                    return `<div class="p-2.5 bg-black/40 border border-white/5 rounded-lg text-[10px] text-zinc-300 font-medium hover:bg-white/10 hover:text-white cursor-pointer transition-colors" onclick="focusOnNode('${n.id}')">${label}</div>`;
                })
                .join('');
        }

        function resetView() {
            resetState();
        }

        function resetState() {
            currentAnalyticFilter = null;
            setActiveAnalyticButton(null);

            closeReport();
            closeSidebar();

            osintEnabled = false;
            pivotLayoutOn = false;
            clusterOn = false;

            setToggleActive('osint-toggle', false);
            setToggleActive('pivot-toggle', false);
            setToggleActive('cluster-toggle', false);

            const search = document.getElementById('node-search');
            if (search) search.value = '';

            // –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞—Ç –∫ –±–∞–∑–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –ª—é–±—ã–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏/—Å–∫—Ä—ã—Ç–∏—è.
            nodes.clear();
            edges.clear();
            nodes.add(rawNodesData.map(n => ({ ...n, hidden: false, fixed: false, x: undefined, y: undefined })));
            edges.add(processedEdges.map(e => ({ ...e, hidden: false })));

            network.setOptions({ physics: { enabled: true } });
            network.startSimulation();
            network.fit({ animation: { duration: 800, easingFunction: "easeInOutQuad" } });
        }

        function closeSidebar() { document.getElementById('info-sidebar').classList.add('hidden'); network.unselectAll(); }
        function closeReport() { document.getElementById('analytic-report').classList.add('hidden'); }

        // OSINT TOGGLE
        let osintEnabled = false;
        function toggleOsint(btnElement) {
            osintEnabled = !osintEnabled;
            setToggleActive('osint-toggle', osintEnabled);

            // OSINT —Ä–µ–∂–∏–º –Ω–µ –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–≤–µ—Ä—Ö –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è.
            if (osintEnabled) {
                clearAnalyticFilter({ fit: false });
                showAllNodesAndEdges();
            } else {
                // –ü—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ OSINT –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∏–∑–∏–∫—É/–ø–æ–∑–∏—Ü–∏–∏, –µ—Å–ª–∏ –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã layout-—Ä–µ–∂–∏–º—ã.
                disableLayouts();
            }

            const osintGroups = ['osint_ip', 'osint_domain', 'osint_email', 'osint_url', 'osint_asn', 'osint_misc'];
            const allNodes = nodes.get();
            const osintNodeIds = allNodes.filter(n => osintGroups.includes(n.group)).map(n => n.id);

            if (osintEnabled) {
                const updates = allNodes.map(n => {
                    const isOsint = osintGroups.includes(n.group);
                    if (isOsint) {
                        return { id: n.id, color: { background: undefined, border: undefined }, size: undefined };
                    }
                    return {
                        id: n.id,
                        color: { background: 'rgba(100,100,100,0.02)', border: 'rgba(100,100,100,0.02)' },
                        size: 2
                    };
                });
                nodes.update(updates);

                if (osintNodeIds.length > 0) {
                    network.fit({ nodes: osintNodeIds, animation: { duration: 800, easingFunction: "easeInOutQuad" } });
                }
                return;
            }

            const updates = allNodes.map(n => ({
                id: n.id,
                color: { background: undefined, border: undefined },
                size: undefined
            }));
            nodes.update(updates);
            network.fit({ animation: { duration: 800, easingFunction: "easeInOutQuad" } });
        }

        // === PIVOT RADIAL LAYOUT ===
        let pivotLayoutOn = false;

        function isOsintNode(n) {
            return (n.group || '').startsWith('osint_');
        }
        function isAnchor(n) {
            return (n.info || '').toLowerCase().includes('anchor');
        }
        function isInfraHost(n) {
            const lbl = (n.label || n.id || '').toLowerCase();
            return lbl.startsWith('ns') || lbl.startsWith('mx') || lbl.startsWith('emx.') || lbl.startsWith('dns');
        }

        function placeRing(list, radius, startAngle, updates) {
            const n = list.length || 1;
            for (let i = 0; i < list.length; i++) {
                const ang = startAngle + (2 * Math.PI * i) / n;
                const x = Math.round(radius * Math.cos(ang));
                const y = Math.round(radius * Math.sin(ang));
                updates.push({ id: list[i].id, x, y, fixed: { x: true, y: true } });
            }
        }

        function applyPivotRadialLayout() {
            const os = nodes.get({ filter: n => isOsintNode(n) && !n.hidden });

            const asn    = os.filter(n => n.group === 'osint_asn');
            const ip     = os.filter(n => n.group === 'osint_ip');
            const anchor = os.filter(n => isAnchor(n));
            const infra  = os.filter(n => n.group === 'osint_domain' && !isAnchor(n) && isInfraHost(n));
            const other  = os.filter(n =>
                !asn.includes(n) && !ip.includes(n) && !anchor.includes(n) && !infra.includes(n)
            );

            const updates = [];

            if (asn.length === 1) {
                updates.push({ id: asn[0].id, x: 0, y: 0, fixed: { x: true, y: true } });
            } else {
                placeRing(asn, 45, 0, updates);
            }

            placeRing(ip,     150, 0.2, updates);
            placeRing(infra,  240, 0.0, updates);
            placeRing(other,  300, 0.1, updates);
            placeRing(anchor, 380, 0.0, updates);

            nodes.update(updates);
            network.setOptions({ physics: { enabled: false } });
            network.fit({ nodes: os.map(n => n.id), animation: { duration: 600, easingFunction: "easeInOutQuad" } });
        }

        function clearPivotRadialLayout() {
            const os = nodes.get({ filter: n => isOsintNode(n) });
            nodes.update(os.map(n => ({ id: n.id, fixed: false, x: undefined, y: undefined })));
            network.setOptions({ physics: { enabled: true } });
            network.stabilize(200);
            network.fit({ animation: { duration: 600, easingFunction: "easeInOutQuad" } });
        }

        function togglePivotLayout(btn) {
            if (!osintEnabled) toggleOsint(document.getElementById('osint-toggle'));
            clearAnalyticFilter({ fit: false });

            pivotLayoutOn = !pivotLayoutOn;
            setToggleActive('pivot-toggle', pivotLayoutOn);

            if (pivotLayoutOn) {
                if (clusterOn) {
                    clusterOn = false;
                    setToggleActive('cluster-toggle', false);
                    clearClusterLayout();
                }
                applyPivotRadialLayout();
                return;
            }
            clearPivotRadialLayout();
        }

        // === CLUSTER LAYOUT (–æ—Å—Ç—Ä–æ–≤–∞ –≤–æ–∫—Ä—É–≥ MX/NS) ===
        let clusterOn = false;

        // –¶–µ–Ω—Ç—Ä—ã –∫–ª–∞—Å—Ç–µ—Ä–æ–≤: –ø–æ—á—Ç–∞ + Timeweb
        const CLUSTER_CENTERS = ["mx.yandex.net", "emx.mail.ru", "ns1.timeweb.ru"];
        const CENTER_POS = {
            "mx.yandex.net":  { x: -260, y: 0 },
            "emx.mail.ru":    { x:  260, y: 0 },
            "ns1.timeweb.ru": { x:    0, y: -240 }
        };

        function getClusterForNode(nodeId) {
            const allEdges = edges.get();
            const connected = allEdges.filter(e =>
                (e.from === nodeId || e.to === nodeId) &&
                CLUSTER_CENTERS.includes(e.from === nodeId ? e.to : e.from)
            );
            if (connected.length > 0) {
                const center = connected[0].from === nodeId ? connected[0].to : connected[0].from;
                if (CLUSTER_CENTERS.includes(center)) return center;
            }
            if (CLUSTER_CENTERS.includes(nodeId)) return nodeId;
            return null;
        }

        function applyClusterLayout() {
            const os = nodes.get({ filter: n => isOsintNode(n) && !n.hidden });
            const updates = [];

            for (const centerId of CLUSTER_CENTERS) {
                const centerNode = os.find(n => n.id === centerId);
                if (centerNode && CENTER_POS[centerId]) {
                    updates.push({
                        id: centerId,
                        x: CENTER_POS[centerId].x,
                        y: CENTER_POS[centerId].y,
                        fixed: { x: true, y: true },
                        size: 25
                    });
                }
            }

            const clusters = { "mx.yandex.net": [], "emx.mail.ru": [], "ns1.timeweb.ru": [] };
            for (const node of os) {
                if (CLUSTER_CENTERS.includes(node.id)) continue;
                const cluster = getClusterForNode(node.id);
                if (cluster && clusters[cluster]) {
                    clusters[cluster].push(node);
                }
            }

            const radius = 120;
            for (const [centerId, nodeList] of Object.entries(clusters)) {
                if (nodeList.length === 0) continue;
                const centerPos = CENTER_POS[centerId];
                if (!centerPos) continue;

                const startAngle = centerId === "mx.yandex.net" ? -Math.PI/2 :
                                   centerId === "emx.mail.ru" ? Math.PI/2 : 0;

                for (let i = 0; i < nodeList.length; i++) {
                    const angle = startAngle + (2 * Math.PI * i) / nodeList.length;
                    const x = Math.round(centerPos.x + radius * Math.cos(angle));
                    const y = Math.round(centerPos.y + radius * Math.sin(angle));
                    updates.push({
                        id: nodeList[i].id,
                        x, y,
                        fixed: { x: true, y: true }
                    });
                }
            }

            nodes.update(updates);
            network.setOptions({ physics: { enabled: false } });
            network.fit({ animation: { duration: 600, easingFunction: "easeInOutQuad" } });
        }

        function clearClusterLayout() {
            const os = nodes.get({ filter: n => isOsintNode(n) });
            nodes.update(os.map(n => ({ id: n.id, fixed: false, x: undefined, y: undefined, size: undefined })));
            network.setOptions({ physics: { enabled: true } });
            network.stabilize(200);
            network.fit({ animation: { duration: 600, easingFunction: "easeInOutQuad" } });
        }

        function toggleClusterLayout(btn) {
            if (!osintEnabled) toggleOsint(document.getElementById('osint-toggle'));
            clearAnalyticFilter({ fit: false });

            clusterOn = !clusterOn;
            setToggleActive('cluster-toggle', clusterOn);

            if (clusterOn) {
                if (pivotLayoutOn) {
                    pivotLayoutOn = false;
                    setToggleActive('pivot-toggle', false);
                    clearPivotRadialLayout();
                }
                applyClusterLayout();
                return;
            }
            clearClusterLayout();
        }

    </script>
</body>
</html>
